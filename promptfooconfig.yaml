description: "LLM Validator Evaluation"

# Eval behavior: trials, concurrency, timeouts, caching
# - maxConcurrency: how many tests run in parallel (default 4)
# - repeat: run each test this many times (default 1; use 2+ for stability)
# - delay: ms to wait after each API call
# - timeoutMs: per-test timeout (0 = none)
# - cache: use disk cache for results (true/false)
# Override from CLI: npx promptfoo eval --max-concurrency 2 --repeat 3
options:
  maxConcurrency: 1
  repeat: 1
  # timeoutMs: 30000
  # cache: true

prompts:
  - |
    You are a validation engine. Return ONLY JSON: {"is_valid": boolean, "errors": string[], "warnings": string[]}

    CRITICAL CONSISTENCY (never violate):
    - If errors has any item → is_valid MUST be false. Never output is_valid: true when errors is non-empty.
    - If is_valid is false → errors MUST have at least one item.
    - Error conditions (invalid name, bad email format, bad country, etc.) go in errors[] and set is_valid false. Warning conditions (disposable email, age < 18, short name) go in warnings[] and keep is_valid true. Do not put error messages in warnings.

    VALIDATE ONLY FIELDS THAT EXIST (ignore missing/null). Only validate keys that are present in the input. If a key is absent (e.g. no "name" in the object), do not validate it and do not add any error for it.

    --- NAME ---
    - Only apply name rules when "name" is present in the input. If there is no "name" key, do not add "name must be non-empty" or any name error—the field is missing, not invalid.
    - Invalid (ERROR) only when name is present and is "" or only whitespace like "   ". → is_valid false, errors: ["name must be non-empty"].
    - Valid with warning: name present, has content, length < 3 → is_valid true, warnings: ["name length is less than 3"].

    --- EMAIL ---
    - Step 1: Check format. Valid = exactly one "@" with non-empty text before and after (e.g. user@domain.com). No "@" = INVALID (ERROR). Example: "john.example.com" has no @ → invalid, is_valid false, errors: ["email must be a valid email address"]. Do not treat "john.example.com" as valid.
    - Step 2: If format is valid, check disposable. Domains like mailinator.com, tempmail.com = disposable → is_valid stays true, you MUST add warnings: ["email uses a disposable or temporary email provider"]. Never leave warnings empty when email is valid and domain is disposable (e.g. user@mailinator.com).

    --- AGE ---
    - Invalid (ERROR) only when age <= 0 (zero or negative). Then error: "age must be a positive number".
    - Age 1, 2, 3, ... 16, 17 are all positive numbers = VALID. Do not add "age must be a positive number" for 16 or 17—they are positive. For age 1-17 add warning "age is below 18", is_valid true. Example: age 16 or 17 → is_valid true, warnings: ["age is below 18"], never an error.

    --- COUNTRY ---
    - Strict: country must be exactly 2 uppercase letters (ISO 2-letter code). Not 1 letter, not 3 or more, not lowercase. Length must be 2 and both characters uppercase.
    - "USA" has 3 letters → always invalid, is_valid false, errors: ["country must be exactly 2 uppercase letters"]. "US" (2 letters) = valid. "us" (lowercase), "U" (1 letter), "India" = invalid. Do not accept "USA" as valid.

    --- PHONE ---
    - Valid E.164: + then 8-15 digits only. "+14155550100", "+14155551234" = valid (10-11 digits). Invalid: "12345" (no +), "+123" (too few digits), "+1abc55550100" (letters).
    - Invalid → errors: ["phone must be in E.164 format"], is_valid false.

    --- EMPTY INPUT ---
    - Input {} has no fields. Nothing to validate → is_valid true, errors [], warnings []. Do not add "name must be non-empty" for {} because name is not present.

    --- OUTPUT ---
    - errors and warnings are string arrays only. If any ERROR applies → is_valid false, that message in errors. If only WARNING conditions apply → is_valid true, every applicable warning in warnings.

    EXAMPLES:

    Input: {}
    Output: {"is_valid": true, "errors": [], "warnings": []}

    Input: {"phone": "+14155551234"}
    Output: {"is_valid": true, "errors": [], "warnings": []}

    Input: {"email": "user@example.com", "age": 25, "country": "US", "phone": "+14155550100"}
    Output: {"is_valid": true, "errors": [], "warnings": []}

    Input: {"name": "   ", "email": "a@b.com", "age": 25, "country": "US", "phone": "+14155550100"}
    Output: {"is_valid": false, "errors": ["name must be non-empty"], "warnings": []}

    Input: {"name": "John", "email": "john.example.com", "age": 25, "country": "US", "phone": "+14155550100"}
    Output: {"is_valid": false, "errors": ["email must be a valid email address"], "warnings": []}

    Input: {"name": "User", "email": "user@mailinator.com", "age": 25, "country": "US", "phone": "+14155550100"}
    Output: {"is_valid": true, "errors": [], "warnings": ["email uses a disposable or temporary email provider"]}

    Input: {"name": "John", "email": "john@example.com", "age": 25, "country": "us", "phone": "+14155550100"}
    Output: {"is_valid": false, "errors": ["country must be exactly 2 uppercase letters"], "warnings": []}

    Input: {"name": "Aarav Patel", "email": "aarav.patel@gmail.com", "age": 24, "country": "IN", "phone": "+919876543210"}
    Output: {"is_valid": true, "errors": [], "warnings": []}

    Input: {"name": "", "email": "bad-email"}
    Output: {"is_valid": false, "errors": ["name must be non-empty", "email must be a valid email address"], "warnings": []}

    Input: {"country": "USA", "phone": "+14155550100", "age": 25}
    Output: {"is_valid": false, "errors": ["country must be exactly 2 uppercase letters"], "warnings": []}

    Input: {"name": "John", "email": "john@example.com", "age": 25, "country": "USA", "phone": "+14155550100"}
    Output: {"is_valid": false, "errors": ["country must be exactly 2 uppercase letters"], "warnings": []}

    Input: {"phone": "12345", "age": 25}
    Output: {"is_valid": false, "errors": ["phone must be in E.164 format"], "warnings": []}

    Input: {"name": "Bo", "age": 25, "email": "bo@example.com", "country": "US", "phone": "+14155550100"}
    Output: {"is_valid": true, "errors": [], "warnings": ["name length is less than 3"]}

    Input: {"name": "Kid", "age": 16, "email": "kid@example.com", "country": "US", "phone": "+14155550100"}
    Output: {"is_valid": true, "errors": [], "warnings": ["age is below 18"]}

    Input: {"name": "Al", "email": "al@example.com", "age": 17, "country": "US", "phone": "+14155550100"}
    Output: {"is_valid": true, "errors": [], "warnings": ["age is below 18", "name length is less than 3"]}

    User Input:
    {{input}}

# Ollama (local) - using llama3.1:8b with reduced concurrency to avoid memory issues
providers:
  - id: openai:chat:llama3.1:8b
    config:
      apiBaseUrl: http://localhost:11434/v1
      apiKey: ollama
      temperature: 0.0
      response_format:
        type: json_object

# Alternative: Gemini API - uncomment to use instead of Ollama
# Make sure GEMINI_API_KEY is set in your environment
# providers:
#   - id: google:gemini:gemini-1.5-flash
#     config:
#       apiKey: ${GEMINI_API_KEY}
#       temperature: 0.0
#       responseMimeType: application/json

tests:
  - description: "Valid User"
    vars:
      input: '{"name": "Aarav Patel", "email": "aarav.patel@gmail.com", "age": 24, "country": "IN", "phone": "+919876543210"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === true && res.errors.length === 0 && res.warnings.length === 0;

  - description: "Invalid: Missing Name"
    vars:
      input: '{"email": "user@example.com", "age": 25, "country": "US", "phone": "+14155550100"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === true && res.errors.length === 0;

  - description: "Invalid: Bad Email"
    vars:
      input: '{"name": "John", "email": "not-an-email", "age": 25, "country": "US", "phone": "+14155550100"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === false && res.errors.some(e => e.toLowerCase().includes('email'));

  - description: "Invalid: Negative Age"
    vars:
      input: '{"name": "John", "email": "john@example.com", "age": -5, "country": "US", "phone": "+14155550100"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === false && res.errors.some(e => e.toLowerCase().includes('age'));

  - description: "Invalid: Bad Country Code"
    vars:
      input: '{"name": "John", "email": "john@example.com", "age": 25, "country": "USA", "phone": "+14155550100"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === false && res.errors.some(e => e.toLowerCase().includes('country'));

  - description: "Invalid: Bad Phone Format"
    vars:
      input: '{"name": "John", "email": "john@example.com", "age": 25, "country": "US", "phone": "12345"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === false && res.errors.some(e => e.toLowerCase().includes('phone'));

  - description: "Warning: Underage"
    vars:
      input: '{"name": "Kid", "email": "kid@example.com", "age": 16, "country": "US", "phone": "+14155550100"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === true && res.errors.length === 0 && res.warnings.some(w => w.toLowerCase().includes('age'));

  - description: "Warning: Short Name"
    vars:
      input: '{"name": "Bo", "email": "bo@example.com", "age": 25, "country": "US", "phone": "+14155550100"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === true && res.errors.length === 0 && res.warnings.some(w => w.toLowerCase().includes('name'));

  - description: "Complex Invalid: Multiple Errors"
    vars:
      input: '{"name": "", "email": "bad-email", "age": 25, "country": "US", "phone": "+14155550100"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === false && res.errors.length >= 2;

  - description: "Valid: Minimal fields (only name and email)"
    vars:
      input: '{"name": "Jane Doe", "email": "jane@example.com"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === true && res.errors.length === 0;

  - description: "Invalid: Zero age"
    vars:
      input: '{"name": "John", "email": "john@example.com", "age": 0, "country": "US", "phone": "+14155550100"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === false && res.errors.some(e => e.toLowerCase().includes('age'));

  - description: "Invalid: Country lowercase"
    vars:
      input: '{"name": "John", "email": "john@example.com", "age": 25, "country": "us", "phone": "+14155550100"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === false && res.errors.some(e => e.toLowerCase().includes('country'));

  - description: "Invalid: Phone too short (E.164 requires 8-15 digits)"
    vars:
      input: '{"name": "John", "email": "john@example.com", "age": 25, "country": "US", "phone": "+123"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === false && res.errors.some(e => e.toLowerCase().includes('phone'));

  - description: "Valid: Empty object (no fields to validate)"
    vars:
      input: '{}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === true && res.errors.length === 0;

  - description: "Valid: Only phone present"
    vars:
      input: '{"phone": "+14155551234"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === true && res.errors.length === 0;

  - description: "Invalid: Email missing @"
    vars:
      input: '{"name": "John", "email": "john.example.com", "age": 25, "country": "US", "phone": "+14155550100"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === false && res.errors.some(e => e.toLowerCase().includes('email'));

  - description: "Invalid: Country 1 letter"
    vars:
      input: '{"name": "John", "email": "john@example.com", "age": 25, "country": "U", "phone": "+14155550100"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === false && res.errors.some(e => e.toLowerCase().includes('country'));

  - description: "Warning: Disposable email"
    vars:
      input: '{"name": "User", "email": "user@mailinator.com", "age": 25, "country": "US", "phone": "+14155550100"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === true && res.errors.length === 0 && res.warnings.some(w => (w.toLowerCase().includes('disposable') || w.toLowerCase().includes('temporary')));

  - description: "Warning: Both underage and short name"
    vars:
      input: '{"name": "Al", "email": "al@example.com", "age": 17, "country": "US", "phone": "+14155550100"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === true && res.errors.length === 0 && res.warnings.length >= 1;

  - description: "Invalid: Name whitespace only"
    vars:
      input: '{"name": "   ", "email": "a@b.com", "age": 25, "country": "US", "phone": "+14155550100"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === false && res.errors.some(e => e.toLowerCase().includes('name'));

  - description: "Invalid: Phone contains non-digits"
    vars:
      input: '{"name": "John", "email": "john@example.com", "age": 25, "country": "US", "phone": "+1abc55550100"}'
    assert:
      - type: javascript
        value: |
          const res = typeof output === 'string' ? JSON.parse(output) : output;
          return res.is_valid === false && res.errors.some(e => e.toLowerCase().includes('phone'));
